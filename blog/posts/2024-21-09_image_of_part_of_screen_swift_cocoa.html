<!DOCTYPE html> <html><head>
		<title>Taking an image of a part of the screen in a Cocoa app - Extiri Blog</title>
		<base href="./">
		<meta id="root-path" root-path="./">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="Obsidian - Taking an image of a part of the screen in a Cocoa app">
		<meta property="og:title" content="Taking an image of a part of the screen in a Cocoa app">
		<meta property="og:description" content="Obsidian - Taking an image of a part of the screen in a Cocoa app">
		<meta property="og:type" content="website">
		<meta property="og:url" content="Taking an image of a part of the screen in a Cocoa app.html">
		<meta property="og:site_name" content="Obsidian">
		<meta name="author" content="Wiktor Wójcik">
		<script async="" src="../script.js"></script>
		<link rel="stylesheet" href="../style.css">
	</head>
	<body class="publish css-settings-manager show-inline-title">
		<script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script>
		<div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style>
			<div class="markdown-preview-sizer markdown-preview-section">
				<h1>extiri blog</h1>
				<p><a href="../index.html">Blog</a> - <a href="../../../index.html">Extiri homepage</a></p>
				<br>
				<br>
				<h1 class="page-title heading inline-title" id="Taking a screenshot of part of the screen in a Cocoa app">Taking an image of a part of the screen in a Cocoa app</h1><p>Wiktor Wójcik, 21.09.2024<div><p dir="auto">Hi! In this post I will show you how to write a "screenshot taker" for a Cocoa app. It will allow the user to select a part of the screen, just like the builtin screenshot taking tool on macOS. It uses <code>CGWindowListCreateImage</code> (macOS 10.5 - 14.0), so it should work in old codebases although it's important to note that it's deprecated in macOS 14.0. In such case you should use ScreenCaptureKit's captureScreenshot APIs. It should work well for most cases. Well, let's start!</p></div><div><p dir="auto">This code will be pretty lengthy so I will split it into two parts: a manager and a view controller. The manager will be the frontend for screenshot taking and the view controller will be responsible for selecting part of the screen. Let's begin with the manager.</p></div><div class="heading-wrapper"><h3 data-heading="Manager" dir="auto" class="heading" id="Manager"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Manager</h3><div class="heading-children"><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">class</span> <span class="token class-name">ScreenshotManager</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">var</span> windowController<span class="token punctuation">:</span> <span class="token class-name">NSWindowController</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">var</span> isRunning <span class="token operator">=</span> <span class="token boolean">false</span>
	<span class="token keyword">static</span> <span class="token keyword">var</span> completionHandler<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">NSImage</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span> <span class="token punctuation">}</span>
  
	<span class="token keyword">enum</span> <span class="token class-name">SMError</span><span class="token punctuation">:</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> failedToTakeScreenshot
		<span class="token keyword">case</span> noSelection
		<span class="token keyword">case</span> alreadyInUse
		<span class="token keyword">case</span> noPermission
		<span class="token keyword">case</span> noAccessToScreen
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div><p dir="auto">First we define the ScreenshotManager class in which we define the variables and the error type. <code>windowController</code> stores the window controller for selection window, <code>isRunning</code> contains information whether screenshot is already being taken and <code>completionHandler</code> contains a handler that will be called when the user stops selecting or an error happens while selecting. I will use static functions and variables because only one screenshot-taking can happen at a time. Now we will add a function for taking a screenshot from a part of the screen.</p></div><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">class</span> <span class="token class-name">ScreenshotManager</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
	<span class="token attribute atrule">@MainActor</span>
	<span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">take</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> <span class="token class-name">NSRect</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-&gt;</span> <span class="token class-name">NSImage</span> <span class="token punctuation">{</span>
		isRunning <span class="token operator">=</span> <span class="token boolean">false</span>
		
	    <span class="token keyword">let</span> cgRect <span class="token operator">=</span> <span class="token class-name">CGRect</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> frame<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> frame<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>y<span class="token punctuation">,</span> width<span class="token punctuation">:</span> frame<span class="token punctuation">.</span>width<span class="token punctuation">,</span> height<span class="token punctuation">:</span> frame<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
	    <span class="token keyword">guard</span> <span class="token keyword">let</span> screenshot <span class="token operator">=</span> <span class="token class-name">CGWindowListCreateImage</span><span class="token punctuation">(</span>cgRect<span class="token punctuation">,</span> <span class="token punctuation">.</span>optionOnScreenOnly<span class="token punctuation">,</span> <span class="token punctuation">.</span>zero<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	      <span class="token keyword">throw</span> <span class="token class-name">SMError</span><span class="token punctuation">.</span>failedToTakeScreenshot

	    <span class="token punctuation">}</span>

	    <span class="token keyword">return</span> <span class="token class-name">NSImage</span><span class="token punctuation">(</span>cgImage<span class="token punctuation">:</span> screenshot<span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> screenshot<span class="token punctuation">.</span>width<span class="token punctuation">,</span> height<span class="token punctuation">:</span> screenshot<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div><p dir="auto">This function receives a frame with the information about the selection's size and position. Since <a data-tooltip-position="top" aria-label="https://developer.apple.com/documentation/coregraphics/1454852-cgwindowlistcreateimage" rel="noopener" class="external-link" href="https://developer.apple.com/documentation/coregraphics/1454852-cgwindowlistcreateimage" target="_blank">CGWindowListCreateImage</a> needs CGRect, we crate cgRect from the frame. <code>.optionOnScreenOnly</code> means that the image will contain only the visible windows and as the fourth parameter we provide an empty array since we don't need any additional options. <code>.zero</code> is used a reference window ID, but I'm not sure what it means, but I works. Then, we convert the resulting image (<code>screenshot</code>) into an NSImage. Now we need to add the selecting part. We will begin by writing a function that will return the window controller responsible for selecting.</p></div><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">class</span> <span class="token class-name">ScreenshotManager</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
  <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">returnWindowController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">NSWindowController</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> window <span class="token operator">=</span> <span class="token class-name">NSWindow</span><span class="token punctuation">(</span>contentRect<span class="token punctuation">:</span> <span class="token punctuation">.</span>zero<span class="token punctuation">,</span> styleMask<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>fullSizeContentView<span class="token punctuation">]</span><span class="token punctuation">,</span> backing<span class="token punctuation">:</span> <span class="token punctuation">.</span>buffered<span class="token punctuation">,</span> <span class="token keyword">defer</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span>isOpaque <span class="token operator">=</span> <span class="token boolean">false</span>
    window<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">.</span>clear
    window<span class="token punctuation">.</span>titleVisibility <span class="token operator">=</span> <span class="token punctuation">.</span>hidden
    window<span class="token punctuation">.</span>titlebarAppearsTransparent <span class="token operator">=</span> <span class="token boolean">true</span>
    window<span class="token punctuation">.</span>hasShadow <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token keyword">return</span> <span class="token class-name">NSWindowController</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> window<span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div><p dir="auto">This function configures the selection window. It makes it transparent using <code>isOpaque</code> and <code>backgroundColor</code>. It also removes all decorations (titlebar and shadow). Now let's add the main function responsible for starting this process.</p></div><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">class</span> <span class="token class-name">ScreenshotManager</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
	<span class="token attribute atrule">@MainActor</span>
	<span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span>completionHandler<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">NSImage</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Error</span><span class="token operator">?</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>isRunning <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token class-name">SMError</span><span class="token punctuation">.</span>alreadyInUse
	    <span class="token punctuation">}</span>
	    
	    <span class="token keyword">guard</span> <span class="token keyword">let</span> screen <span class="token operator">=</span> <span class="token class-name">NSScreen</span><span class="token punctuation">.</span>main <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">SMError</span><span class="token punctuation">.</span>noAccessToScreen <span class="token punctuation">}</span>
	    
	    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token class-name">CGPreflightScreenCaptureAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		   <span class="token keyword">return</span> <span class="token class-name">SMError</span><span class="token punctuation">.</span>noPermission
	    <span class="token punctuation">}</span>

	    <span class="token keyword">Self</span><span class="token punctuation">.</span>completionHandler <span class="token operator">=</span> completionHandler

	    windowController <span class="token operator">=</span> <span class="token function">returnWindowController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	    windowController<span class="token operator">?</span><span class="token punctuation">.</span>contentViewController <span class="token operator">=</span> <span class="token class-name">SelectionWindowViewController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	    windowController<span class="token operator">?</span><span class="token punctuation">.</span>window<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">setFrame</span><span class="token punctuation">(</span><span class="token class-name">NSRect</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> screen<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token punctuation">,</span> height<span class="token punctuation">:</span> screen<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span> display<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	    windowController<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">showWindow</span><span class="token punctuation">(</span><span class="token nil constant">nil</span><span class="token punctuation">)</span>
	    windowController<span class="token operator">?</span><span class="token punctuation">.</span>window<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">makeKeyAndOrderFront</span><span class="token punctuation">(</span><span class="token nil constant">nil</span><span class="token punctuation">)</span>

		<span class="token keyword">return</span> <span class="token nil constant">nil</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div><p dir="auto">This function accepts the completionHandler that will run once the selection ends and it also returns an error when there is selection already taking place, <code>NSScreen.main</code> is nil and if the app doesn't have a screen capture permission (<code>CGPreflightScreenCaptureAccess()</code>). The function then configures and shows a window controller from the <code>returnWindowController()</code> function. The window will appear on the current space and overlay all windows. Now it's time for the selection window.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="Selection window" dir="auto" class="heading" id="Selection_window"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Selection window</h3><div class="heading-children"><div><p dir="auto">Let's begin by defining the <code>SelectionWindowViewController</code> class inheriting from <code>NSViewController</code>, variables and it's <code>viewDidLoad()</code> function.</p></div><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">class</span> <span class="token class-name">SelectionWindowViewController</span><span class="token punctuation">:</span> <span class="token class-name">NSViewController</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> selectionView<span class="token punctuation">:</span> <span class="token class-name">NSBox</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
  <span class="token keyword">var</span> centerPoint<span class="token punctuation">:</span> <span class="token class-name">CGPoint</span> <span class="token operator">=</span> <span class="token punctuation">.</span>zero
  <span class="token keyword">var</span> overlay<span class="token punctuation">:</span> <span class="token class-name">NSView</span><span class="token operator">!</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>

  <span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    overlay <span class="token operator">=</span> <span class="token class-name">NSView</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> view<span class="token punctuation">.</span>bounds<span class="token punctuation">)</span>
    overlay<span class="token punctuation">.</span>wantsLayer <span class="token operator">=</span> <span class="token boolean">true</span>
	overlay<span class="token punctuation">.</span>layer<span class="token operator">?</span><span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token class-name">NSColor</span><span class="token punctuation">.</span>black<span class="token punctuation">.</span><span class="token function">withAlphaComponent</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cgColor

    view <span class="token operator">=</span> overlay
<span class="token punctuation">}</span>
</code></pre></div><div><p dir="auto">The view controller defines three variables. <code>selectionView</code> which will contain the view that selects part of the screen, <code>overlay</code> view which darkens the screen and the <code>centerPoint</code> containing position of the mouse click. <code>viewDidLoad()</code> configures the overlay by making it transparent with a dark tint controlled by <code>0.5</code> parameter. </p></div><div><blockquote dir="auto">
<p>Note: Builtin screenshot app changes the cursor into crosshair. I tried adding it, but it looks like it loses focus and the cursor changes back. If you want to try to implement it, you will probably need to use a function like <code>self.view.addCursorRect(self.view.bounds, cursor: .crosshair)</code> or <code>NSCursor.crosshair.push()</code>.</p>
</blockquote></div><div><p dir="auto">To achieve the effect of transparent cutout within dark overlay we will need to use <code>CALayer</code> s which is implemented by <code>setMask()</code> function.</p></div><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">class</span> <span class="token class-name">SelectionWindowViewController</span><span class="token punctuation">:</span> <span class="token class-name">NSViewController</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
	<span class="token keyword">func</span> <span class="token function-definition function">setMask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">guard</span> <span class="token keyword">let</span> overlayLayer <span class="token operator">=</span> view<span class="token punctuation">.</span>layer <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>

	    <span class="token keyword">let</span> maskLayer <span class="token operator">=</span> <span class="token class-name">CALayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	    maskLayer<span class="token punctuation">.</span>frame <span class="token operator">=</span> overlayLayer<span class="token punctuation">.</span>bounds
	    
	    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token class-name">CGMutablePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	    path<span class="token punctuation">.</span><span class="token function">addRect</span><span class="token punctuation">(</span>overlayLayer<span class="token punctuation">.</span>bounds<span class="token punctuation">)</span>
	    path<span class="token punctuation">.</span><span class="token function">addRect</span><span class="token punctuation">(</span>selectionView<span class="token operator">!</span><span class="token punctuation">.</span>frame<span class="token punctuation">)</span>
	    
	    <span class="token keyword">let</span> cutoutLayer <span class="token operator">=</span> <span class="token class-name">CAShapeLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	    cutoutLayer<span class="token punctuation">.</span>frame <span class="token operator">=</span> overlayLayer<span class="token punctuation">.</span>bounds
	    cutoutLayer<span class="token punctuation">.</span>fillRule <span class="token operator">=</span> <span class="token punctuation">.</span>evenOdd
	    cutoutLayer<span class="token punctuation">.</span>fillColor <span class="token operator">=</span> <span class="token class-name">NSColor</span><span class="token punctuation">.</span>black<span class="token punctuation">.</span>cgColor
	    cutoutLayer<span class="token punctuation">.</span>path <span class="token operator">=</span> path
	    
	    maskLayer<span class="token punctuation">.</span><span class="token function">addSublayer</span><span class="token punctuation">(</span>cutoutLayer<span class="token punctuation">)</span>
	    overlayLayer<span class="token punctuation">.</span>mask <span class="token operator">=</span> maskLayer
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div><p dir="auto">This function will be called after every movement. It cuts out a part of the overlay. The most important part of this snippet is the <code>.evenOdd</code> fill rule. It is responsible for giving us the cut out effect. How des it work? Claude describes it like this:</p></div><div><pre><code>1. Imagine drawing a line from any point in the plane to infinity.
2. Count the number of times this line crosses the path of your shape.
3. If the number of crossings is odd, the point is inside the shape and gets filled. If the number of crossings is even, the point is outside the shape and doesn't get filled.
</code></pre></div><div><p dir="auto">In the context of this function it works like this:</p></div><div><ol>
<li data-line="0" dir="auto">The path includes two rectangles: one for the entire view bounds, and another for the selection view.</li>
<li data-line="1" dir="auto">For areas outside both rectangles, the line crosses 0 times (even) - not filled.</li>
<li data-line="2" dir="auto">For areas inside the outer rectangle but outside the inner rectangle, the line crosses 1 time (odd) - filled.</li>
<li data-line="3" dir="auto">For areas inside both rectangles, the line crosses 2 times (even) - not filled.</li>
</ol></div><div><p dir="auto">Now let's implement selecting. First we begin with the function detecting first click:</p></div><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">class</span> <span class="token class-name">SelectionWindowViewController</span><span class="token punctuation">:</span> <span class="token class-name">NSViewController</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
  <span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">mouseDown</span><span class="token punctuation">(</span>with event<span class="token punctuation">:</span> <span class="token class-name">NSEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mouseDown</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> event<span class="token punctuation">)</span>

    selectionView <span class="token operator">=</span> <span class="token class-name">NSBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    selectionView<span class="token operator">?</span><span class="token punctuation">.</span>boxType <span class="token operator">=</span> <span class="token punctuation">.</span>custom
    selectionView<span class="token operator">?</span><span class="token punctuation">.</span>cornerRadius <span class="token operator">=</span> <span class="token number">0</span>
    selectionView<span class="token operator">?</span><span class="token punctuation">.</span>fillColor <span class="token operator">=</span> <span class="token punctuation">.</span>lightGray
    selectionView<span class="token operator">?</span><span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>

    <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">addSubview</span><span class="token punctuation">(</span>selectionView<span class="token operator">!</span><span class="token punctuation">)</span>

    selectionView<span class="token operator">?</span><span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    centerPoint <span class="token operator">=</span> selectionView<span class="token operator">!</span><span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin

    <span class="token function">setMask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div><p dir="auto">This function creates the selection view. <code>setMask()</code> uses it create the cutout. It's configuration should be self-explanatory. We also set its origin to the position of the mouse, which is stored in <code>event.locationInWindow</code>, and run <code>setMask()</code> to create the cutout. Now it's time to handle mouse movement.</p></div><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">class</span> <span class="token class-name">SelectionWindowViewController</span><span class="token punctuation">:</span> <span class="token class-name">NSViewController</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
  <span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">mouseDragged</span><span class="token punctuation">(</span>with event<span class="token punctuation">:</span> <span class="token class-name">NSEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mouseDragged</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> event<span class="token punctuation">)</span>

    <span class="token keyword">guard</span> <span class="token keyword">let</span> selectionView <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>

    <span class="token keyword">let</span> width <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>centerPoint<span class="token punctuation">.</span>x <span class="token operator">-</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x<span class="token punctuation">)</span>
    <span class="token keyword">let</span> height <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>centerPoint<span class="token punctuation">.</span>y <span class="token operator">-</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> width<span class="token punctuation">,</span> height<span class="token punctuation">:</span> height<span class="token punctuation">)</span>

    <span class="token keyword">if</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> centerPoint<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> centerPoint<span class="token punctuation">.</span>y <span class="token punctuation">{</span>
      selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> centerPoint<span class="token punctuation">.</span>x <span class="token punctuation">{</span>
      selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> centerPoint<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> centerPoint<span class="token punctuation">.</span>y <span class="token punctuation">{</span>
      selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> centerPoint<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> centerPoint<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> centerPoint<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token function">setMask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div><p dir="auto">Here we need a little bit more work. We first check if the selection view exists, then we calculate and assign the new width and height by taking absolute values of appropriate subtractions. Now we have 4 cases for each possible change of cursor's position relative to the center point (first mouse click. This is because the origin of the selection view has to always be in the bottom-left corner, so if we move cursor down or left relative to the center point we will need to update selection view's origin coordinates.<br>
<img alt="screenshot-layout.png" src="../assets/screenshot-layout.png"></img></p></div><div><ol>
<li data-line="0" dir="auto">Cursor is in the bottom-left part - origin point equal to the cursor position.</li>
<li data-line="1" dir="auto">Cursor is in the top-left part - origin point's x equal to cursor's x and origin point's y equal to center point's y.</li>
<li data-line="2" dir="auto">Cursor is in the bottom-right part - origin point's x equal to center point's x and origin point's y equal to cursor's y.</li>
<li data-line="3" dir="auto">Cursor is in the top-right part - origin point equal to the center point.</li>
</ol></div><div><p dir="auto">Now it's time for the final part - the user finished selecting (mouse up). </p></div><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">class</span> <span class="token class-name">SelectionWindowViewController</span><span class="token punctuation">:</span> <span class="token class-name">NSViewController</span> <span class="token punctuation">{</span>
<span class="token operator">...</span>
  <span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">mouseUp</span><span class="token punctuation">(</span>with event<span class="token punctuation">:</span> <span class="token class-name">NSEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mouseDown</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> event<span class="token punctuation">)</span>

    <span class="token keyword">guard</span> <span class="token keyword">let</span> selectionView <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>

    <span class="token keyword">self</span><span class="token punctuation">.</span>window<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> frame <span class="token operator">=</span> selectionView<span class="token punctuation">.</span>frame
    frame<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token class-name">NSScreen</span><span class="token punctuation">.</span>main<span class="token operator">!</span><span class="token punctuation">.</span>frame<span class="token punctuation">.</span>maxY <span class="token operator">-</span> frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height <span class="token operator">-</span> frame<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>y

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> frame<span class="token punctuation">)</span>
      <span class="token class-name">NSSound</span><span class="token punctuation">.</span><span class="token function">beep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span><span class="token function">completionHandler</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span>completionHandler <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
      <span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span><span class="token function">completionHandler</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span>completionHandler <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> window<span class="token punctuation">:</span> <span class="token class-name">NSWindow</span><span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> window <span class="token keyword">in</span> <span class="token class-name">NSApp</span><span class="token punctuation">.</span>windows <span class="token punctuation">{</span>
      <span class="token keyword">if</span> window<span class="token punctuation">.</span>contentViewController <span class="token operator">==</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> window
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token nil constant">nil</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div><p dir="auto">First we close the window. Now we need to calculate the frame of the selection. Unfortunately, origin's y in the window (same size as the screen) doesn't correspond to the screen's actual position. That's because screen's coordinates are flipped horizontally - y = 0 is on the screen's top-left corner while in a window it's the bottom-left corner. I simply calculate it by subtracting selection's height and origin from screen's height. There are builtin functions to convert between these two coordinate systems but I tried and none of them worked. If you can make them work, then using them would probably be a better practice, but this calculation should be enough. Now we call the <code>ScreenManager.take()</code> function which takes the image of the part of the screen described by the converted selection's frame. For good measure we make a beep. Then we call the currently set completion handler with the image and reset it. In case of an error, we call the completion handler with the error and reset it. I'm also adding a <code>window</code> variable so that we can access the window from it. It's not the most efficient way, but it's enough for this use case.</p></div><div><p dir="auto">Now you have a way to take an image a of part of the screen. Below is the entire code in a single code snippet so you can copy it. Also, as a sidenote, if you are dealing with many snippets of various types, <a href="">CodeMenu</a> can help you organize, access and use their full potential ;).</p></div><div><pre class="language-swift" tabindex="0"><code class="language-swift is-loaded"><span class="token keyword">import</span> <span class="token class-name">Cocoa</span>

	<span class="token keyword">class</span> <span class="token class-name">ScreenshotManager</span> <span class="token punctuation">{</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">var</span> windowController<span class="token punctuation">:</span> <span class="token class-name">NSWindowController</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">var</span> isRunning <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token keyword">static</span> <span class="token keyword">var</span> completionHandler<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">NSImage</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span> <span class="token punctuation">}</span>
	
		<span class="token keyword">enum</span> <span class="token class-name">SMError</span><span class="token punctuation">:</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">LocalizedError</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> failedToTakeScreenshot
			<span class="token keyword">case</span> noSelection
			<span class="token keyword">case</span> alreadyInUse
			<span class="token keyword">case</span> noPermission
			<span class="token keyword">case</span> noAccessToScreen
		<span class="token punctuation">}</span>
	
		<span class="token attribute atrule">@MainActor</span>
		<span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">take</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> <span class="token class-name">NSRect</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-&gt;</span> <span class="token class-name">NSImage</span> <span class="token punctuation">{</span>
			isRunning <span class="token operator">=</span> <span class="token boolean">false</span>
	
			<span class="token keyword">let</span> cgRect <span class="token operator">=</span> <span class="token class-name">CGRect</span><span class="token punctuation">(</span>
				x<span class="token punctuation">:</span> frame<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> frame<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>y<span class="token punctuation">,</span> width<span class="token punctuation">:</span> frame<span class="token punctuation">.</span>width<span class="token punctuation">,</span> height<span class="token punctuation">:</span> frame<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
			<span class="token keyword">guard</span> <span class="token keyword">let</span> screenshot <span class="token operator">=</span> <span class="token class-name">CGWindowListCreateImage</span><span class="token punctuation">(</span>cgRect<span class="token punctuation">,</span> <span class="token punctuation">.</span>optionOnScreenOnly<span class="token punctuation">,</span> <span class="token punctuation">.</span>zero<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token class-name">SMError</span><span class="token punctuation">.</span>failedToTakeScreenshot
			<span class="token punctuation">}</span>
	
			<span class="token keyword">return</span> <span class="token class-name">NSImage</span><span class="token punctuation">(</span>
				cgImage<span class="token punctuation">:</span> screenshot<span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> screenshot<span class="token punctuation">.</span>width<span class="token punctuation">,</span> height<span class="token punctuation">:</span> screenshot<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	
		<span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">returnWindowController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">NSWindowController</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> window <span class="token operator">=</span> <span class="token class-name">NSWindow</span><span class="token punctuation">(</span>
				contentRect<span class="token punctuation">:</span> <span class="token punctuation">.</span>zero<span class="token punctuation">,</span> styleMask<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>fullSizeContentView<span class="token punctuation">]</span><span class="token punctuation">,</span> backing<span class="token punctuation">:</span> <span class="token punctuation">.</span>buffered<span class="token punctuation">,</span> <span class="token keyword">defer</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	
			window<span class="token punctuation">.</span>isOpaque <span class="token operator">=</span> <span class="token boolean">false</span>
			window<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">.</span>clear
			window<span class="token punctuation">.</span>titleVisibility <span class="token operator">=</span> <span class="token punctuation">.</span>hidden
			window<span class="token punctuation">.</span>titlebarAppearsTransparent <span class="token operator">=</span> <span class="token boolean">true</span>
			window<span class="token punctuation">.</span>hasShadow <span class="token operator">=</span> <span class="token boolean">false</span>
	
			<span class="token keyword">return</span> <span class="token class-name">NSWindowController</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> window<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	
		<span class="token attribute atrule">@MainActor</span>
		<span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span>completionHandler<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">NSImage</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Error</span><span class="token operator">?</span> <span class="token punctuation">{</span>
			<span class="token keyword">guard</span> <span class="token keyword">let</span> screen <span class="token operator">=</span> <span class="token class-name">NSScreen</span><span class="token punctuation">.</span>main <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">SMError</span><span class="token punctuation">.</span>noAccessToScreen <span class="token punctuation">}</span>
	
			<span class="token keyword">if</span> <span class="token operator">!</span><span class="token class-name">CGPreflightScreenCaptureAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token class-name">SMError</span><span class="token punctuation">.</span>noPermission
			<span class="token punctuation">}</span>
	
			<span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>isRunning <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token class-name">SMError</span><span class="token punctuation">.</span>alreadyInUse
			<span class="token punctuation">}</span>
	
			<span class="token keyword">Self</span><span class="token punctuation">.</span>completionHandler <span class="token operator">=</span> completionHandler
	
			windowController <span class="token operator">=</span> <span class="token function">returnWindowController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			windowController<span class="token operator">?</span><span class="token punctuation">.</span>contentViewController <span class="token operator">=</span> <span class="token class-name">SelectionWindowViewController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			windowController<span class="token operator">?</span><span class="token punctuation">.</span>window<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">setFrame</span><span class="token punctuation">(</span>
				<span class="token class-name">NSRect</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> screen<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token punctuation">,</span> height<span class="token punctuation">:</span> screen<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
				display<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
			windowController<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">showWindow</span><span class="token punctuation">(</span><span class="token nil constant">nil</span><span class="token punctuation">)</span>
			windowController<span class="token operator">?</span><span class="token punctuation">.</span>window<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">makeKeyAndOrderFront</span><span class="token punctuation">(</span><span class="token nil constant">nil</span><span class="token punctuation">)</span>
	
			<span class="token keyword">return</span> <span class="token nil constant">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">class</span> <span class="token class-name">SelectionWindowViewController</span><span class="token punctuation">:</span> <span class="token class-name">NSViewController</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> selectionView<span class="token punctuation">:</span> <span class="token class-name">NSBox</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
		<span class="token keyword">var</span> centerPoint<span class="token punctuation">:</span> <span class="token class-name">CGPoint</span> <span class="token operator">=</span> <span class="token punctuation">.</span>zero
		<span class="token keyword">var</span> overlay<span class="token punctuation">:</span> <span class="token class-name">NSView</span><span class="token operator">!</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
	
		<span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
			overlay <span class="token operator">=</span> <span class="token class-name">NSView</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> view<span class="token punctuation">.</span>bounds<span class="token punctuation">)</span>
			overlay<span class="token punctuation">.</span>wantsLayer <span class="token operator">=</span> <span class="token boolean">true</span>
			overlay<span class="token punctuation">.</span>layer<span class="token operator">?</span><span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token class-name">NSColor</span><span class="token punctuation">.</span>black<span class="token punctuation">.</span><span class="token function">withAlphaComponent</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cgColor
			view <span class="token operator">=</span> overlay
	
			<span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">addCursorRect</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>bounds<span class="token punctuation">,</span> cursor<span class="token punctuation">:</span> <span class="token punctuation">.</span>crosshair<span class="token punctuation">)</span>
			<span class="token class-name">NSCursor</span><span class="token punctuation">.</span>crosshair<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	
		<span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">mouseDown</span><span class="token punctuation">(</span>with event<span class="token punctuation">:</span> <span class="token class-name">NSEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mouseDown</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> event<span class="token punctuation">)</span>
	
			selectionView <span class="token operator">=</span> <span class="token class-name">NSBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
			selectionView<span class="token operator">?</span><span class="token punctuation">.</span>boxType <span class="token operator">=</span> <span class="token punctuation">.</span>custom
			selectionView<span class="token operator">?</span><span class="token punctuation">.</span>cornerRadius <span class="token operator">=</span> <span class="token number">0</span>
			selectionView<span class="token operator">?</span><span class="token punctuation">.</span>fillColor <span class="token operator">=</span> <span class="token punctuation">.</span>lightGray
			selectionView<span class="token operator">?</span><span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string-literal"><span class="token string">""</span></span>
	
			<span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">addSubview</span><span class="token punctuation">(</span>selectionView<span class="token operator">!</span><span class="token punctuation">)</span>
	
			selectionView<span class="token operator">?</span><span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
			centerPoint <span class="token operator">=</span> selectionView<span class="token operator">!</span><span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin
	
			<span class="token function">setMask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	
		<span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">mouseDragged</span><span class="token punctuation">(</span>with event<span class="token punctuation">:</span> <span class="token class-name">NSEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mouseDragged</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> event<span class="token punctuation">)</span>
	
			<span class="token keyword">guard</span> <span class="token keyword">let</span> selectionView <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
	
			<span class="token keyword">let</span> width <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>centerPoint<span class="token punctuation">.</span>x <span class="token operator">-</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x<span class="token punctuation">)</span>
			<span class="token keyword">let</span> height <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>centerPoint<span class="token punctuation">.</span>y <span class="token operator">-</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
	
			selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> width<span class="token punctuation">,</span> height<span class="token punctuation">:</span> height<span class="token punctuation">)</span>
	
			<span class="token keyword">if</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> centerPoint<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> centerPoint<span class="token punctuation">.</span>y <span class="token punctuation">{</span>
				selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> centerPoint<span class="token punctuation">.</span>x <span class="token punctuation">{</span>
				selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> centerPoint<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> centerPoint<span class="token punctuation">.</span>y <span class="token punctuation">{</span>
				selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> centerPoint<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> event<span class="token punctuation">.</span>locationInWindow<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				selectionView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> centerPoint<span class="token punctuation">.</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> centerPoint<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
	
			<span class="token function">setMask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	
		<span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">mouseUp</span><span class="token punctuation">(</span>with event<span class="token punctuation">:</span> <span class="token class-name">NSEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">mouseDown</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> event<span class="token punctuation">)</span>
	
			<span class="token keyword">guard</span> <span class="token keyword">let</span> selectionView <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
	
			<span class="token keyword">self</span><span class="token punctuation">.</span>window<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
			<span class="token keyword">var</span> frame <span class="token operator">=</span> selectionView<span class="token punctuation">.</span>frame
			frame<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token class-name">NSScreen</span><span class="token punctuation">.</span>main<span class="token operator">!</span><span class="token punctuation">.</span>frame<span class="token punctuation">.</span>maxY <span class="token operator">-</span> frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height <span class="token operator">-</span> frame<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>y
	
			<span class="token keyword">do</span> <span class="token punctuation">{</span>
				<span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> frame<span class="token punctuation">)</span>
				<span class="token class-name">NSSound</span><span class="token punctuation">.</span><span class="token function">beep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span><span class="token function">completionHandler</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span>completionHandler <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span> <span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
				<span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span><span class="token function">completionHandler</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token class-name">ScreenshotManager</span><span class="token punctuation">.</span>completionHandler <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token omit keyword">_</span> <span class="token keyword">in</span> <span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	
		<span class="token keyword">func</span> <span class="token function-definition function">setMask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">guard</span> <span class="token keyword">let</span> overlayLayer <span class="token operator">=</span> view<span class="token punctuation">.</span>layer <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
	
			<span class="token keyword">let</span> maskLayer <span class="token operator">=</span> <span class="token class-name">CALayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			maskLayer<span class="token punctuation">.</span>frame <span class="token operator">=</span> overlayLayer<span class="token punctuation">.</span>bounds
	
			<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token class-name">CGMutablePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			path<span class="token punctuation">.</span><span class="token function">addRect</span><span class="token punctuation">(</span>overlayLayer<span class="token punctuation">.</span>bounds<span class="token punctuation">)</span>
			path<span class="token punctuation">.</span><span class="token function">addRect</span><span class="token punctuation">(</span>selectionView<span class="token operator">!</span><span class="token punctuation">.</span>frame<span class="token punctuation">)</span>
	
			<span class="token keyword">let</span> cutoutLayer <span class="token operator">=</span> <span class="token class-name">CAShapeLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			cutoutLayer<span class="token punctuation">.</span>frame <span class="token operator">=</span> overlayLayer<span class="token punctuation">.</span>bounds
			cutoutLayer<span class="token punctuation">.</span>fillRule <span class="token operator">=</span> <span class="token punctuation">.</span>evenOdd
			cutoutLayer<span class="token punctuation">.</span>fillColor <span class="token operator">=</span> <span class="token class-name">NSColor</span><span class="token punctuation">.</span>black<span class="token punctuation">.</span>cgColor
			cutoutLayer<span class="token punctuation">.</span>path <span class="token operator">=</span> path
	
			maskLayer<span class="token punctuation">.</span><span class="token function">addSublayer</span><span class="token punctuation">(</span>cutoutLayer<span class="token punctuation">)</span>
			overlayLayer<span class="token punctuation">.</span>mask <span class="token operator">=</span> maskLayer
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">extension</span> <span class="token class-name">NSViewController</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> window<span class="token punctuation">:</span> <span class="token class-name">NSWindow</span><span class="token operator">?</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> window <span class="token keyword">in</span> <span class="token class-name">NSApp</span><span class="token punctuation">.</span>windows <span class="token punctuation">{</span>
				<span class="token keyword">if</span> window<span class="token punctuation">.</span>contentViewController <span class="token operator">==</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> window
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
	
			<span class="token keyword">return</span> <span class="token nil constant">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	</code></pre></div><div class="mod-footer"></div></div></div></div></div></body></html>